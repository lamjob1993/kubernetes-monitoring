# –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç K8s –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (cAdvisor) –∏ –∫–∞–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—Å—è Java –∫–æ–Ω–≤–µ–π–µ—Ä (Actuator)?

## **–ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

–ó–¥–µ—Å—å **Kubernetes API**, –∫–∞–∫ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è (—Å—É—â–Ω–æ—Å—Ç—å) –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É **Prometheus** –∏ —Å–∞–º–∏–º –∫–ª–∞—Å—Ç–µ—Ä–æ–º **Kubernetes**. –° –ø–æ–º–æ—â—å—é –º–µ—Ö–∞–Ω–∏–∑–º–∞ Prometheus **(Service Discovery)** –ü—Ä–æ–º–µ—Ç–µ—É—Å –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ K8s, –æ–±—Ä–∞—â–∞—è—Å—å –∫ **Kubernetes API**, –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å **Kubernetes API** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–∞–∫ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –¥–ª—è **Prometheus**. –í—Å—ë –¥–æ–≤–æ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ.

```mermaid
flowchart LR
    subgraph Kubernetes Cluster
        kubelet -->|"cAdvisor\n(–º–µ—Ç—Ä–∏–∫–∏ CPU/RAM/–î–∏—Å–∫–∏)"| Prometheus
        kube-state-metrics -->|"—Å—Ç–∞—Ç—É—Å—ã –ø–æ–¥–æ–≤\n(Pods/Deployments)"| Prometheus
        JavaApp["Java App (Spring Boot)"] -->|"Actuator\n(/actuator/prometheus)"| Prometheus
    end

    Prometheus -->|"Service Discovery\n(–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ç–∞—Ä–≥–µ—Ç–æ–≤/—Ü–µ–ª–µ–π)"| KubernetesAPI["Kubernetes API"]
    KubernetesAPI -->|"–æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫\n–ø–æ–¥–æ–≤/—Å–µ—Ä–≤–∏—Å–æ–≤"| Prometheus
    Prometheus -->|"—Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ"| Grafana
    Grafana -->|"–¥–∞—à–±–æ—Ä–¥—ã"| Admin[["–ê–¥–º–∏–Ω"]]
```

### üîç [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Service Discovery:](https://github.com/lamjob1993/linux-monitoring/blob/main/prometheus/beginning/8.%20%D0%A1%D0%B5%D1%80%D0%B2%D0%B8%D1%81-%D0%B4%D0%B8%D1%81%D0%BA%D0%B0%D0%B2%D0%B5%D1%80%D0%B8%20(Service%20Discovery).md)
1. **Prometheus —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É Kubernetes API**:
   - _"–ö–∞–∫–∏–µ –ø–æ–¥—ã/—Å–µ—Ä–≤–∏—Å—ã/–Ω–æ–¥—ã —É —Ç–µ–±—è –µ—Å—Ç—å?"_
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–æ–ª–∏:
     - `role: pod` (–¥–ª—è Java Actuator)
     - `role: service` (–¥–ª—è kube-state-metrics)
     - `role: node` (–¥–ª—è cAdvisor)

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏** (–ø—Ä–∏–º–µ—Ä –¥–ª—è Java Actuator):
   ```yaml
   # –í Deployment –ø–æ–¥–∞ Java-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
   annotations:
     prometheus.io/scrape: "true"    # <- "–°–æ–±–∏—Ä–∞–π –º–æ–∏ –º–µ—Ç—Ä–∏–∫–∏!"
     prometheus.io/port: "8080"      # –ü–æ—Ä—Ç Actuator
     prometheus.io/path: "/actuator/prometheus"
   ```

3. **Prometheus –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞—Ä–≥–µ—Ç—ã/—Ü–µ–ª–∏** –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).

### üõ†Ô∏è –ß—Ç–æ –∫—É–¥–∞ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç            | –ö–∞–∫ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è                          | –ü—Ä–∏–º–µ—Ä –º–µ—Ç—Ä–∏–∫                     |
|----------------------|--------------------------------------------|-----------------------------------|
| **cAdvisor**         | –ê–≤—Ç–æ–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–¥ (`role: node`)         | `container_cpu_usage_seconds`     |
| **kube-state-metrics** | –°–µ—Ä–≤–∏—Å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º (`role: service`) | `kube_pod_status_phase`       |
| **Java Actuator**    | –ü–æ–¥—ã —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π `prometheus.io/scrape`   | `http_server_requests_seconds`    |

### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥ Prometheus (—Ñ—Ä–∞–≥–º–µ–Ω—Ç):
```yaml
scrape_configs:
  # –î–ª—è Java Actuator
  - job_name: 'java-apps'
    kubernetes_sd_configs:
      - role: pod  # –ò—â–µ–º –ø–æ–¥—ã
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: "true"  # –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ø–æ–¥—ã —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π

  # –î–ª—è cAdvisor
  - job_name: 'cadvisor'
    kubernetes_sd_configs:
      - role: node  # –ò—â–µ–º –Ω–æ–¥—ã

  # –î–ª—è kube-state-metrics
  - job_name: 'kube-state-metrics'
    kubernetes_sd_configs:
      - role: service
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: kube-state-metrics
```

### üîÑ –ö—Ä—É–≥–æ–≤–æ—Ä–æ—Ç –¥–∞–Ω–Ω—ã—Ö:
1. **Kubernetes API** —Å–æ–æ–±—â–∞–µ—Ç Prometheus: _"–í–æ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–¥–æ–≤/—Å–µ—Ä–≤–∏—Å–æ–≤/–Ω–æ–¥"_.
2. **Prometheus** —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–∞—Ä–≥–µ—Ç—ã/—Ü–µ–ª–∏ –ø–æ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º –∏ —Ä–æ–ª—è–º.
3. **cAdvisor/kube-state-metrics/Actuator** –æ—Ç–¥–∞—é—Ç –º–µ—Ç—Ä–∏–∫–∏.
4. **Grafana** –±–µ—Ä—ë—Ç –¥–∞–Ω–Ω—ã–µ (Data Source) –∏–∑ Prometheus –∏ —Ä–∏—Å—É–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∏.

–¢–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç **–≤—Å—ë**:
- –ù–∞–≥—Ä—É–∑–∫—É –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (cAdvisor) ‚Üí _"Java-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∂—Ä—ë—Ç 90% CPU!"_ / **–ø–æ—Ö–æ–∂–∞—è —Ä–æ–ª—å –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–µ Node Exporter**
- –°—Ç–∞—Ç—É—Å—ã –ø–æ–¥–æ–≤ (kube-state-metrics) ‚Üí _"–ü–æ–¥ calculator-adapter –≤ —Å—Ç–∞—Ç—É—Å–µ CrashLoopBackOff!"_ / **—Ä–æ–ª—å —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–æ–≤, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏ —Ç.–¥**
- –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏ (Actuator) ‚Üí _"API /orders –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 1000 RPS!"_ / **—Ä–æ–ª—å —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–¥–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ —Å Java-–∞–¥–∞–ø—Ç–µ—Ä–æ–≤**

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–∞–¥–∞–µ—Ç ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å–º–æ—Ç—Ä–∏—Ç–µ **–ª–æ–≥–∏ –ø–æ–¥–æ–≤**, –ø–æ—Ç–æ–º **–º–µ—Ç—Ä–∏–∫–∏ cAdvisor**, –ø–æ—Ç–æ–º **kube-state-metrics**. üöë
